<?php /*

 Composr
 Copyright (c) ocProducts, 2004-2016

 See text/EN/licence.txt for full licencing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license    http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright  ocProducts Ltd
 * @package    addon_publish
 */

/*EXTRA FUNCTIONS: json_decode,json_encode*/

function init__transifex()
{
    define('TRANSLATE_PRIORITY_NORMAL', 0);
    define('TRANSLATE_PRIORITY_HIGH', 1);
    define('TRANSLATE_PRIORITY_URGENT', 2);

    define('TRANSLATE_CORE', 'core');
    define('TRANSLATE_ADDON', 'non-bundled addon');

    define('TRANSLATE_ADMINISTRATIVE_YES', 0);
    define('TRANSLATE_ADMINISTRATIVE_NO', 1);
    define('TRANSLATE_ADMINISTRATIVE_MIXED', 2);

    require_code('addons');
    require_code('lang_compile');
    require_code('lang2');
    require_code('files2');

    require_code('string_scan');
    global $JUST_LANG_STRINGS_ADMIN;
    list($JUST_LANG_STRINGS_ADMIN) = string_scan(fallback_lang(), true);
    $JUST_LANG_STRINGS_ADMIN = array_flip($JUST_LANG_STRINGS_ADMIN);

    global $URGENT_PRIORITY_LANGUAGE_FILES;
    $URGENT_PRIORITY_LANGUAGE_FILES = array('global.ini', 'cns.ini', 'news.ini');

    // Extra files to send to Transifex (additional to .ini files)
    global $EXTRA_LANGUAGE_FILES;
    $EXTRA_LANGUAGE_FILES = array(
        'adminzone/pages/comcode/EN/netlink.txt' => array(null, TRANSLATE_PRIORITY_NORMAL, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_YES),
        'adminzone/pages/comcode/EN/quotes.txt' => array(null, TRANSLATE_PRIORITY_NORMAL, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_YES),
        'adminzone/pages/comcode_custom/EN/comcode_whitelist.txt' => array(null, TRANSLATE_PRIORITY_NORMAL, TRANSLATE_ADDON, TRANSLATE_ADMINISTRATIVE_YES),
        'adminzone/pages/comcode_custom/EN/insults.txt' => array(null, TRANSLATE_PRIORITY_NORMAL, TRANSLATE_ADDON, TRANSLATE_ADMINISTRATIVE_YES),
        'adminzone/pages/comcode_custom/EN/referrals.txt' => array(null, TRANSLATE_PRIORITY_NORMAL, TRANSLATE_ADDON, TRANSLATE_ADMINISTRATIVE_YES),
        'buildr/pages/comcode_custom/EN/docs.txt' => array(null, TRANSLATE_PRIORITY_NORMAL, TRANSLATE_ADDON, TRANSLATE_ADMINISTRATIVE_NO),
        'buildr/pages/comcode_custom/EN/rules.txt' => array(null, TRANSLATE_PRIORITY_NORMAL, TRANSLATE_ADDON, TRANSLATE_ADMINISTRATIVE_NO),
        'data/modules/cms_comcode_pages/EN/about_us.txt' => array(null, TRANSLATE_PRIORITY_NORMAL, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_YES),
        'data/modules/cms_comcode_pages/EN/advertise.txt' => array(null, TRANSLATE_PRIORITY_NORMAL, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_YES),
        'data/modules/cms_comcode_pages/EN/article.txt' => array(null, TRANSLATE_PRIORITY_NORMAL, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_YES),
        'data/modules/cms_comcode_pages/EN/competitor_comparison.txt' => array(null, TRANSLATE_PRIORITY_NORMAL, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_YES),
        'data/modules/cms_comcode_pages/EN/contact_us.txt' => array(null, TRANSLATE_PRIORITY_NORMAL, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_YES),
        'data/modules/cms_comcode_pages/EN/donate.txt' => array(null, TRANSLATE_PRIORITY_NORMAL, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_YES),
        'data/modules/cms_comcode_pages/EN/guestbook.txt' => array(null, TRANSLATE_PRIORITY_NORMAL, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_YES),
        'data/modules/cms_comcode_pages/EN/landing_page.txt' => array(null, TRANSLATE_PRIORITY_NORMAL, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_YES),
        'data/modules/cms_comcode_pages/EN/press_release.txt' => array(null, TRANSLATE_PRIORITY_NORMAL, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_YES),
        'data/modules/cms_comcode_pages/EN/pricing.txt' => array(null, TRANSLATE_PRIORITY_NORMAL, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_YES),
        'data/modules/cms_comcode_pages/EN/rules_balanced.txt' => array(null, TRANSLATE_PRIORITY_URGENT, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_NO),
        'data/modules/cms_comcode_pages/EN/rules_corporate.txt' => array(null, TRANSLATE_PRIORITY_URGENT, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_NO),
        'data/modules/cms_comcode_pages/EN/rules_liberal.txt' => array(null, TRANSLATE_PRIORITY_URGENT, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_NO),
        'data/modules/cms_comcode_pages/EN/two_column_layout.txt' => array(null, TRANSLATE_PRIORITY_NORMAL, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_YES),
        'data/modules/cms_comcode_pages/EN/under_construction.txt' => array(null, TRANSLATE_PRIORITY_NORMAL, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_YES),
        'pages/comcode/EN/404.txt' => array(null, TRANSLATE_PRIORITY_HIGH, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_NO),
        'pages/comcode/EN/_rules.txt' => array(null, TRANSLATE_PRIORITY_NORMAL, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_NO),
        'pages/comcode/EN/feedback.txt' => array(null, TRANSLATE_PRIORITY_URGENT, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_NO),
        'pages/comcode/EN/keymap.txt' => array(null, TRANSLATE_PRIORITY_NORMAL, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_NO),
        'pages/comcode/EN/privacy.txt' => array(null, TRANSLATE_PRIORITY_URGENT, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_NO),
        'pages/comcode/EN/recommend_help.txt' => array(null, TRANSLATE_PRIORITY_NORMAL, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_NO),
        'pages/comcode/EN/rules.txt' => array(null, TRANSLATE_PRIORITY_NORMAL, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_NO),
        'pages/comcode/EN/sitemap.txt' => array(null, TRANSLATE_PRIORITY_URGENT, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_NO),
        'site/pages/comcode/EN/help.txt' => array(null, TRANSLATE_PRIORITY_URGENT, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_NO),
        'site/pages/comcode/EN/popup_blockers.txt' => array(null, TRANSLATE_PRIORITY_NORMAL, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_NO),
        'site/pages/comcode/EN/userguide_chatcode.txt' => array(null, TRANSLATE_PRIORITY_HIGH, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_NO),
        'site/pages/comcode/EN/userguide_comcode.txt' => array(null, TRANSLATE_PRIORITY_HIGH, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_NO),
        'text/EN/quotes.txt' => array(null, TRANSLATE_PRIORITY_NORMAL, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_NO),
        'text/EN/synonyms.txt' => array(null, TRANSLATE_PRIORITY_NORMAL, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_YES),
        'text/EN/too_common_words.txt' => array(null, TRANSLATE_PRIORITY_NORMAL, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_NO),
        'text/EN/word_characters.txt' => array(null, TRANSLATE_PRIORITY_NORMAL, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_NO),
        'text_custom/EN/insults.txt' => array(null, TRANSLATE_PRIORITY_NORMAL, TRANSLATE_ADDON, TRANSLATE_ADMINISTRATIVE_NO),
    );
    $EXTRA_LANGUAGE_FILES['adminzone/pages/comcode/EN/' . DEFAULT_ZONE_PAGE_NAME . '.txt'] = array(null, TRANSLATE_PRIORITY_NORMAL, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_YES);
    $EXTRA_LANGUAGE_FILES['buildr/pages/comcode_custom/EN/' . DEFAULT_ZONE_PAGE_NAME . '.txt'] = array(null, TRANSLATE_PRIORITY_NORMAL, TRANSLATE_ADDON, TRANSLATE_ADMINISTRATIVE_NO);
    $EXTRA_LANGUAGE_FILES['pages/comcode/EN/' . DEFAULT_ZONE_PAGE_NAME . '.txt'] = array(null, TRANSLATE_PRIORITY_NORMAL, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_NO);
    $EXTRA_LANGUAGE_FILES['site/pages/comcode/EN/' . DEFAULT_ZONE_PAGE_NAME . '.txt'] = array(null, TRANSLATE_PRIORITY_NORMAL, TRANSLATE_CORE, TRANSLATE_ADMINISTRATIVE_NO);
    foreach ($EXTRA_LANGUAGE_FILES as $file => &$properties) {
        $properties[0] = basename(str_replace('/', '__', $file), '.txt') . (($properties[3] == TRANSLATE_ADMINISTRATIVE_YES) ? '__administrative' : '');
    }

    // Find what language files are in what addons
    $addons = find_all_hooks('systems', 'addon_registry');
    global $LANGUAGE_FILES_ADDON, $EXISTING_LANGUAGE_AUTHORS;
    $LANGUAGE_FILES_ADDON = array();
    $EXISTING_LANGUAGE_AUTHORS = array();
    foreach (array_keys($addons) as $addon) {
        $info = read_addon_info($addon);
        $matches = array();
        foreach ($info['files'] as $file) {
            if (preg_match('#^lang(_custom)?/' . fallback_lang() . '/(\w+)\.ini$#', $file, $matches) != 0) {
                $LANGUAGE_FILES_ADDON[$matches[2]] = $addon;
            }

            if (preg_match('#^(.*/' . fallback_lang() . '/.*\.txt)$#', $file, $matches) != 0) {
                $LANGUAGE_FILES_ADDON[$matches[1]] = $addon;
            }
        }
        if (preg_match('#^language\_(\w+)$#', $addon, $matches) != 0) {
            $EXISTING_LANGUAGE_AUTHORS[$matches[1]] = explode(', ', $info['author']);
        }
    }

    // Find language string descriptions
    global $LANGUAGE_STRING_DESCRIPTIONS;
    $LANGUAGE_STRING_DESCRIPTIONS = get_lang_file_section(fallback_lang(), null, 'descriptions');

    global $LANG_FILES;
    $LANG_FILES = get_lang_files(fallback_lang());
}

function convert_lang_code_to_transifex($lang)
{
    if ($lang == 'ZH-CN') {
        return 'zh'; // We use Google Translate name as a special case
    }

    $lang_parts = explode('_', $lang, 2);
    return strtolower($lang_parts[0]) . (isset($lang_parts[1]) ? ('_' . $lang_parts[1]) : '');
}

function transifex_push_script()
{
    if (!$GLOBALS['DEV_MODE']) {
        if (!is_cli()) {
            header('Content-type: text/plain');
            exit('Must run this script on command line, for security reasons');
        }
    }

    @header('Content-type: text/plain; charset=' . get_charset());
    safe_ini_set('ocproducts.xss_detect', '0');

    $core_only = (get_param_integer('core_only', 0) == 1);
    $push_cms = (get_param_integer('push_cms', 1) == 1);
    $push_ini = (get_param_integer('push_ini', 1) == 1);
    $push_translations = (get_param_integer('push_translations', 0) == 1);
    $limit_substring = get_param_string('limit_substring', null);

    push_to_transifex($core_only, $push_cms, $push_ini, $push_translations, $limit_substring);

    echo 'Done';
}

function push_to_transifex($core_only, $push_cms, $push_ini, $push_translations, $limit_substring)
{
    global $EXISTING_LANGUAGE_AUTHORS, $EXTRA_LANGUAGE_FILES;

    push_query_limiting(false);
    if (php_function_allowed('set_time_limit')) {
        set_time_limit(3000);
    }

    $project_slug = 'composr-cms-' . str_replace('.', '-', strval(cms_version()));

    // Create project if it does not already exist
    $args = array(
        'slug' => $project_slug,
        'name' => 'Composr CMS ' . strval(cms_version()),
        'source_language_code' => convert_lang_code_to_transifex(fallback_lang()),
        'description' => 'Community translation for Composr CMS ' . strval(cms_version()),
        'private' => false,
        'license' => 'permissive_open_source',
        'repository_url' => 'https://github.com/ocproducts/composr',
        'organization' => 'ocproducts',
        'team'=> 39268, // This is a hard-coded known value for the ocProducts organisation
        'fill_up_resources' => true,
        'homepage' => 'http://compo.sr',
        'trans_instructions' => 'See http://compo.sr/docs/tut_intl.htm',
    );
    $test = _transifex('/projects/', 'POST', json_encode($args), false);
    if ($test[1] == '201') { // If creation happened
        // Create translations for all defined languages
        $langs = better_parse_ini_file(get_file_base() . '/lang/langs.ini');
        $failed_langs = array();
        foreach (array_keys($langs) as $lang) {
            if ($lang == fallback_lang()) {
                continue;
            }

            $test = _transifex('/project/' . $project_slug . '/language/' . convert_lang_code_to_transifex($lang) . '/', 'GET', null, false);
            if ($test[1] == '404') {
                if (isset($EXISTING_LANGUAGE_AUTHORS[$lang])) {
                    $coordinators = $EXISTING_LANGUAGE_AUTHORS[$lang];
                } else {
                    $coordinators = array();
                }
                $coordinators[] = get_value('transifex_username', null, true);

                $args = array(
                    'language_code' => convert_lang_code_to_transifex($lang),
                    'coordinators' => $coordinators,
                );
                $test = _transifex('/project/' . $project_slug . '/languages/?skip_invalid_username', 'POST', json_encode($args));

                // May not fail, not all languages supported (https://www.transifex.com/languages/)
                if ($test[1] == '400') {
                    $failed_langs[] = $lang; // We don't use this array, but it is useful for debugging. We try and prune any obscure languages from langs.ini that Transifex doesn't support (because very few people will speak them)
                }
            }
        }

        echo "A new project was created. You need to manually edit the organization settings (https://www.transifex.com/ocproducts/settings/tm/) to add it to the translation memory group.\n";
    }

    // Upload special files
    if ($push_cms) {
        foreach ($EXTRA_LANGUAGE_FILES as $path => $extra_file) {
            if (($limit_substring !== null) && (strpos($path, $limit_substring) === false)) {
                continue;
            }

            _push_cms_file_to_transifex($path, $extra_file[0], $project_slug, $extra_file[1], $extra_file[3], $extra_file[2], $push_translations);

            echo "Uploaded CMS file {$path}\n";
            flush();
        }
    }

    // Upload translatable language files
    if ($push_ini) {
        $d = get_file_base() . '/lang/' . fallback_lang();
        $dh = opendir($d);
        $default_lang_files = array();
        while (($f = readdir($dh)) !== false) {
            if (substr($f, -4) == '.ini') {
                if (($limit_substring !== null) && (strpos($f, $limit_substring) === false)) {
                    continue;
                }

                $default_lang_files[$f] = true;
                $result = _push_strings_file_to_transifex($f, $project_slug, false, TRANSLATE_ADMINISTRATIVE_NO, $push_translations);
                if ($result) {
                    _push_strings_file_to_transifex($f, $project_slug, false, TRANSLATE_ADMINISTRATIVE_YES, $push_translations);

                    echo "Uploaded strings file {$f}\n";
                    flush();
                }
            }
        }
        closedir($dh);
        if (!$core_only) {
            $d = get_file_base() . '/lang_custom/' . fallback_lang();
            $dh = opendir($d);
            while (($f = readdir($dh)) !== false) {
                if ((substr($f, -4) == '.ini') && (!isset($default_lang_files[$f]))) {
                    if (($limit_substring !== null) && (strpos($f, $limit_substring) === false)) {
                        continue;
                    }

                    $result = _push_strings_file_to_transifex($f, $project_slug, true, TRANSLATE_ADMINISTRATIVE_MIXED, $push_translations);

                    if ($result) {
                        echo "Uploaded strings file {$f}\n";
                        flush();
                    }
                }
            }
            closedir($dh);
        }
    }
}

function _push_cms_file_to_transifex($path, $resource_path, $project_slug, $priority, $administrative, $category, $push_translations)
{
    global $LANGUAGE_FILES_ADDON;

    $full_path = get_file_base() . '/' . $path;
    $c = file_get_contents($full_path);

    // Upload
    $test = _transifex('/project/' . $project_slug . '/resource/' . $resource_path . '/', 'GET');
    $categories = array($category);
    if ($LANGUAGE_FILES_ADDON[$path] != $category) {
        // Addon name
        $categories[] = $LANGUAGE_FILES_ADDON[$path];
    }
    $args = array(
        'slug' => $resource_path,
        'name' => $resource_path,
        'accept_translations' => true,
        'categories' => $categories,
        'priority' => $priority,
    );
    if ($test[1] == '200') {
        // Edit
        $test = _transifex('/project/' . $project_slug . '/resource/' . $resource_path . '/', 'PUT', json_encode($args));
        $test = _transifex('/project/' . $project_slug . '/resource/' . $resource_path . '/content/', 'PUT', json_encode(array('content' => $c)));
    } else {
        // Add
        $test = _transifex('/project/' . $project_slug . '/resources/', 'POST', json_encode($args + array('i18n_type' => 'TXT', 'content' => $c)));
    }

    // Upload existing translated files for this language file
    if ($push_translations) {
        foreach (array_keys(find_all_langs()) as $lang) {
            if ($lang != fallback_lang()) {
                $trans_full_path = str_replace('/' . fallback_lang() . '/', '/' . $lang . '/', $full_path);
                if (is_file($trans_full_path)) {
                    $c2 = file_get_contents($trans_full_path);

                    $args = array('content' => $c2);
                    _transifex('/project/' . $project_slug . '/resource/' . $resource_path . '/translation/' . convert_lang_code_to_transifex($lang) . '/', 'PUT', json_encode($args));

                    echo "Uploaded translation {$trans_full_path}\n";
                    flush();
                }
            }
        }
    }
}

function _push_strings_file_to_transifex($f, $project_slug, $custom, $administrative, $push_translations)
{
    global $JUST_LANG_STRINGS_ADMIN, $URGENT_PRIORITY_LANGUAGE_FILES, $LANGUAGE_STRING_DESCRIPTIONS, $LANGUAGE_FILES_ADDON;

    if ($custom) {
        $category = TRANSLATE_ADDON;
    } else {
        $category = TRANSLATE_CORE;
    }

    if ((in_array($f, $URGENT_PRIORITY_LANGUAGE_FILES)) && ($administrative != TRANSLATE_ADMINISTRATIVE_YES)) {
        $priority = TRANSLATE_PRIORITY_URGENT;
    } else {
        if (($custom) || ($administrative == TRANSLATE_ADMINISTRATIVE_YES)) {
            $priority = TRANSLATE_PRIORITY_NORMAL;
        } else {
            $priority = TRANSLATE_PRIORITY_HIGH;
        }
    }

    $_f = basename($f, '.ini');
    $_f_extended = $_f . (($administrative == TRANSLATE_ADMINISTRATIVE_YES) ? '__administrative' : '');

    if (!isset($LANGUAGE_FILES_ADDON[$_f])) {
        echo "Unrecognised language file skipped {$_f}\n";
        return false;
    }

    // Rebuild as a simpler .ini file
    $map = get_lang_file_map(fallback_lang(), $_f, !$custom);
    $c = '';
    foreach ($map as $key => $val) {
        if (($administrative != TRANSLATE_ADMINISTRATIVE_YES) || (isset($JUST_LANG_STRINGS_ADMIN[$key]))) {
            $c .= $key . '=' . str_replace("\n", '\n', $val) . "\n";
        }
    }

    // Upload
    $test = _transifex('/project/' . $project_slug . '/resource/' . $_f_extended . '/', 'GET');
    $categories = array($category);
    if ($LANGUAGE_FILES_ADDON[$_f] != $category) {
        // Addon name
        $categories[] = $LANGUAGE_FILES_ADDON[$_f];
    }
    $args = array(
        'slug' => $_f_extended,
        'name' => $_f_extended,
        'accept_translations' => true,
        'priority' => $priority,
    );
    if (count($categories) == 1) {
        $args['category'] = $categories[0];
    } else {
        $args['categories'] = $categories;
    }
    if ($test[1] == '200') {
        // Edit
        $test = _transifex('/project/' . $project_slug . '/resource/' . $_f_extended . '/', 'PUT', json_encode($args));
        $test = _transifex('/project/' . $project_slug . '/resource/' . $_f_extended . '/content/', 'PUT', json_encode(array('content' => $c)));
    } else {
        // Add
        $test = _transifex('/project/' . $project_slug . '/resources/', 'POST', json_encode($args + array('i18n_type' => 'INI', 'content' => $c)));
    }

    // Set metadata
    foreach ($map as $key => $val) {
        if (isset($LANGUAGE_STRING_DESCRIPTIONS[$key])) {
            $descrip = $LANGUAGE_STRING_DESCRIPTIONS[$key];
            $hash = md5($key . ':');
            $args = array('comment' => $descrip);
            $test = _transifex('/project/' . $project_slug . '/resource/' . $_f_extended . '/source/' . $hash . '/', 'PUT', json_encode($args));
        }
    }

    // Upload existing translated files for this language file
    if ($push_translations) {
        $d = get_file_base() . '/lang_custom';
        $dh = opendir($d);
        while (($lang = readdir($dh)) !== false) {
            if ((is_dir($d . '/' . $lang)) && (does_lang_exist($lang)) && ($lang != fallback_lang())) {
                if (is_file($d . '/' . $lang . '/' . $f)) {
                    $map = get_lang_file_map($lang, $_f, false);
                    $c2 = '';
                    foreach ($map as $key => $val) {
                        if (($administrative != TRANSLATE_ADMINISTRATIVE_YES) || (isset($JUST_LANG_STRINGS_ADMIN[$key]))) {
                            $c2 .= $key . '=' . str_replace("\n", '\n', $val) . "\n";
                        }
                    }

                    $args = array('content' => $c2);
                    _transifex('/project/' . $project_slug . '/resource/' . $_f_extended . '/translation/' . convert_lang_code_to_transifex($lang) . '/', 'PUT', json_encode($args));
                }
            }
        }
        closedir($dh);
    }

    return true;
}

function transifex_pull_script()
{
    $version = get_param_string('version', strval(cms_version()));
    $output = (get_param_integer('output', 0) == 1);
    $lang = get_param_string('lang', null);
    $core_only = (get_param_integer('core_only', 1) == 1);

    if ($output) {
        header('Content-type: application/octet-stream');
        header('Content-Disposition: attachment; filename="' . escape_header($lang) . '.tar"');
        safe_ini_set('ocproducts.xss_detect', '0');

        require_code('tar');
        $tar_file = tar_open(null, 'wb');
    } else {
        $tar_file = null;
    }

    pull_from_transifex($version, $tar_file, $lang, $core_only);

    if ($output) {
        $GLOBALS['SCREEN_TEMPLATE_CALLED'] = '';
        exit();
    } else {
        header('Content-type: text/plain; charset=' . get_charset());
        safe_ini_set('ocproducts.xss_detect', '0');
        echo 'Done';
    }
}

function pull_from_transifex($version, $tar_file, $lang, $core_only)
{
    $project_slug = 'composr-cms-' . str_replace('.', '-', $version);

    push_query_limiting(false);
    if (php_function_allowed('set_time_limit')) {
        set_time_limit(3000);
    }

    if ($lang === null) {
        $langs = array_keys(better_parse_ini_file(get_file_base() . '/lang/langs.ini'));
        foreach ($langs as $lang) {
            if ($lang != fallback_lang()) {
                pull_lang_from_transifex($project_slug, $tar_file, $lang, $core_only, false);
            }
        }
    } else {
        pull_lang_from_transifex($project_slug, $tar_file, $lang, $core_only, true);
    }
}

function pull_lang_from_transifex($project_slug, $tar_file, $lang, $core_only, $definitely_want)
{
    global $EXTRA_LANGUAGE_FILES, $LANG_FILES;

    $test = _transifex('/project/' . $project_slug . '/language/' . convert_lang_code_to_transifex($lang) . '/?details', 'GET', null, false);
    if ($test[1] == '401') {
        warn_exit('Access denied using your username. Does it have write-access to this language?');
    }
    if ($test[1] == '200') {
        $language_details = json_decode($test[0], true);

        if (!$definitely_want) {
            if (floatval($language_details['translated_segments']) / floatval($language_details['total_segments']) < 0.2) {
                // Not translated enough
                return false;
            }
        }

        $files = array();

        // Grab special files
        foreach ($EXTRA_LANGUAGE_FILES as $path => $extra_file) {
            if (($core_only) && ($extra_file[2] != TRANSLATE_CORE)) {
                continue;
            }

            _pull_cms_file_to_transifex($project_slug, $tar_file, $lang, $path, $extra_file, $files);
        }

        // Grab translatable language files
        foreach (array_keys($LANG_FILES) as $_f) {
            if (($core_only) && (!is_file(get_file_base() . '/lang/' . fallback_lang() . '/' . $_f . '.ini'))) {
                continue;
            }

            _pull_strings_file_to_transifex($project_slug, $tar_file, $lang, $_f, $files);
        }

        // Write addon_registry hook
        if (count($files) != 0) {
            $translators = implode(', ', $language_details['translators']);
            if ($translators == '') {
                $translators = do_lang('UNKNOWN');
            }

            $percentage = intval(round(100.0 * $language_details['translated_segments'] / $language_details['total_segments']));

            $language_name = lookup_language_full_name($lang);

            $files_str = '';
            foreach ($files as $file) {
                $files_str .= "\n            '" . $file . "',";
            }

            $open = '<' . '?php';

            $c = <<<END
{$open} /*

 Composr
 Copyright (c) ocProducts, 2004-2016

 See text/EN/licence.txt for full licencing information.

*/

/**
 * @license    http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright  ocProducts Ltd
 * @package    language_{$lang}
 */

/**
 * Hook class.
 */
class Hook_addon_registry_addon_publish
{
    /**
     * Get a list of file permissions to set
     *
     * @param  boolean \$runtime Whether to include wildcards represented runtime-created chmoddable files
     * @return array File permissions to set
     */
    public function get_chmod_array(\$runtime = false)
    {
        return array();
    }

    /**
     * Get the version of Composr this addon is for
     *
     * @return float Version number
     */
    public function get_version()
    {
        return cms_version_number();
    }

    /**
     * Get the addon category
     *
     * @return string The category
     */
    public function get_category()
    {
        return 'Translations';
    }

    /**
     * Get the addon author
     *
     * @return string The author
     */
    public function get_author()
    {
        return '{$translators}';
    }

    /**
     * Find other authors
     *
     * @return array A list of co-authors that should be attributed
     */
    public function get_copyright_attribution()
    {
        return array();
    }

    /**
     * Get the addon licence (one-line summary only)
     *
     * @return string The licence
     */
    public function get_licence()
    {
        return 'Licensed on the same terms as Composr';
    }

    /**
     * Get the description of the addon
     *
     * @return string Description of the addon
     */
    public function get_description()
    {
        return 'Translation into {$language_name}. Completeness: {$percentage}%. This addon was automatically bundled from community contributions provided on Transifex and will be routinely updated alongside new Composr patch releases. Translations may also be downloaded directly from Transifex.';
    }

    /**
     * Get a list of tutorials that apply to this addon
     *
     * @return array List of tutorials
     */
    public function get_applicable_tutorials()
    {
        return array('tut_intl', 'tut_intl_users');
    }

    /**
     * Get a mapping of dependency types
     *
     * @return array File permissions to set
     */
    public function get_dependencies()
    {
        return array(
            'requires' => array(),
            'recommends' => array(),
            'conflicts_with' => array()
        );
    }

    /**
     * Explicitly say which icon should be used
     *
     * @return URLPATH Icon
     */
    public function get_default_icon()
    {
        return 'themes/default/images/icons/48x48/menu/adminzone/style/language/language';
    }

    /**
     * Get a list of files that belong to this addon
     *
     * @return array List of files
     */
    public function get_file_list()
    {
        return array(
            'sources_custom/hooks/systems/addon_registry/language_{$lang}.php',{$files_str}
        );
    }
}
END;

            $c = trim($c) . "\n\n";

            $path = 'sources_custom/hooks/systems/addon_registry/language_' . $lang . '.php';
            $full_path = get_file_base() . '/' . $path;

            if ($tar_file === null) {
                file_put_contents($full_path, $c);
                fix_permissions($full_path);
            } else {
                tar_add_file($tar_file, $path, $c);
            }
        }
    }

    return true;
}

function _pull_cms_file_to_transifex($project_slug, $tar_file, $lang, $path, $extra_file, &$files)
{
    $resource_path = $extra_file[0];
    $trans_path = str_replace('/' . fallback_lang() . '/', '/' . $lang . '/', $resource_path);
    $trans_full_path = get_file_base() . '/' . $trans_path;
    $test = _transifex('/project/' . $project_slug . '/resource/' . $resource_path . '/translation/' . convert_lang_code_to_transifex($lang) . '/', 'GET', null, true);
    if ($test[1] == '200') {
        $data = json_decode($test[0], true);
        $c = $data['content'];

        if ($tar_file === null) {
            @mkdir(dirname($trans_full_path), 0777);
            fix_permissions(dirname($trans_full_path));
            file_put_contents($trans_full_path, $c);
            fix_permissions($trans_full_path);
        } else {
            tar_add_file($tar_file, $trans_path, $c);
        }

        $files[] = $trans_path;
    }
}

function _pull_strings_file_to_transifex($project_slug, $tar_file, $lang, $_f, &$files)
{
    $test_a = _transifex('/project/' . $project_slug . '/resource/' . $_f . '/translation/' . convert_lang_code_to_transifex($lang) . '/', 'GET', null, true);
    $test_b = _transifex('/project/' . $project_slug . '/resource/' . $_f . '__administrative/translation/' . convert_lang_code_to_transifex($lang) . '/', 'GET', null, true);
    if ($test_a[1] == '200' || $test_b[1] == '200') {
        if ($test_a[1] == '200') {
            $data_a = json_decode($test_a[0], true);
        } else {
            $data_a = array('content' => '');
        }
        if ($test_b[1] == '200') {
            $data_b = json_decode($test_b[0], true);
        } else {
            $data_b = array('content' => '');
        }

        $write_out = preg_replace('#^\# .*\n#m', '', $data_a['content'] . "\n" . $data_b['content']);
        $c = "[strings]\n" . $write_out;

        $trans_path = 'lang_custom/' . $lang . '/' . $_f . '.ini';
        $trans_full_path = get_file_base() . '/' . $trans_path;

        if ($tar_file === null) {
            @mkdir(dirname($trans_full_path), 0777, true);
            fix_permissions(dirname($trans_full_path));
            file_put_contents($trans_full_path, $c);
            fix_permissions($trans_full_path);
        } else {
            tar_add_file($tar_file, $trans_path, $c);
        }

        $files[] = $trans_path;
    }
}

function _transifex($call, $http_verb, $params = null, $trigger_error = true)
{
    if ($params === null) {
        $params = array();
    }

    $username = get_param_string('username', get_value('transifex_username', null, true));
    $password = get_param_string('password', get_value('transifex_password', null, true));

    if (empty($username)) {
        warn_exit('Transifex username must be set with :set_value(\'transifex_username\', \'...\', true);', true);
    }
    if (empty($password)) {
        warn_exit('Transifex password must be set with :set_value(\'transifex_password\', \'...\', true);', true);
    }

    if (substr($call, 0, 1) != '/') {
        warn_exit('Calls must start with /');
    }
    if (substr($call, -1) != '/' && strpos($call, '/?') === false) {
        warn_exit('Calls must end with /');
    }

    if (is_array($params)) {
        $raw_content_type = 'multipart/form-data';
        $raw_post = false;
    } else {
        $raw_content_type = 'application/json';
        $raw_post = true;
        $params = array($params);
    }

    $url = 'https://www.transifex.com/api/2' . $call;
    $auth = array($username, $password);
    global $HTTP_MESSAGE;
    $result = http_download_file($url, null, $trigger_error, false, 'Composr', ($http_verb == 'GET') ? null : $params, null, null, null, null, null, null, $auth, 30.0, $raw_post, null, null, $http_verb, $raw_content_type);

    if (is_cli()) {
        @print('Done call to ' . $url . ' [' . $HTTP_MESSAGE . ']' . "\n");
    }

    // Meet rate limit requirement
    /*
    Commented out because Transifex API is too slow for it to make a difference anyway!!
    if ($http_verb == 'GET') {
        usleep(200000);
    } else {
        usleep(500000);
    }*/

    return array($result, $HTTP_MESSAGE);
}

<?php /*

 Composr
 Copyright (c) ocProducts, 2004-2018

 See text/EN/licence.txt for full licensing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license    http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright  ocProducts Ltd
 * @package    newsletter
 */

/**
 * Script to read in a bounced e-mail.
 */
function incoming_bounced_email_script()
{
    if (!addon_installed('newsletter')) {
        warn_exit(do_lang_tempcode('MISSING_ADDON', escape_html('newsletter')));
    }

    if (!GOOGLE_APPENGINE) {
        return;
    }

    if (!gae_is_admin()) {
        return;
    }

    header('X-Robots-Tag: noindex');

    $bounce_email = file_get_contents('php://input');

    $matches = array();
    if (preg_match('#^From: .*([^ ]+@[^ ]+)#m', $bounce_email, $matches) != 0) {
        $email = $matches[1];

        $id = $GLOBALS['SITE_DB']->query_select_value_if_there('newsletter_subscribers', 'id', array('email' => $email));
        if ($id !== null) {
            delete_newsletter_subscriber($id);
        }
    }
}

/**
 * Add to the newsletter, in the simplest way.
 * No authorisation support here, checks it works only for non-subscribed or non-confirmed members.
 *
 * @param  EMAIL $email The e-mail address of the subscriber
 * @param  ?LANGUAGE_NAME $language The language (null: users)
 * @param  boolean $get_confirm_mail Whether to require a confirmation mail
 * @param  ?AUTO_LINK $newsletter_id The newsletter to join (null: the first)
 * @param  string $forename Subscribers forename
 * @param  string $surname Subscribers surname
 * @return string Newsletter password
 */
function basic_newsletter_join($email, $language = null, $get_confirm_mail = false, $newsletter_id = null, $forename = '', $surname = '')
{
    require_lang('newsletter');

    if ($language === null) {
        $language = user_lang();
    }
    if ($newsletter_id === null) {
        $newsletter_id = db_get_first_id();
    }

    $code_confirm = $GLOBALS['SITE_DB']->query_select_value_if_there('newsletter_subscribers', 'code_confirm', array('email' => $email));
    if ($code_confirm === null) {
        // New, set their details
        require_code('crypt');
        $password = get_secure_random_string();
        $salt = get_secure_random_string();
        $code_confirm = $get_confirm_mail ? get_secure_random_number() : 0;
        add_newsletter_subscriber($email, time(), $code_confirm, ratchet_hash($password, $salt), $salt, $language, $forename, $surname);
    } else {
        if ($code_confirm > 0) {
            // Was not confirmed, allow confirm mail to go again as if this was new, and update their details
            $id = $GLOBALS['SITE_DB']->query_select_value_if_there('newsletter_subscribers', 'id', array('email' => $email));
            if ($id !== null) {
                edit_newsletter_subscriber($id, $email, time(), null, null, null, $language, $forename, $surname);
            }
            $password = do_lang('NEWSLETTER_PASSWORD_ENCRYPTED');
        } else {
            // Already on newsletter and confirmed so don't allow tampering without authorisation, which this method can't do
            return do_lang('NA');
        }
    }

    // Send confirm e-mail
    if ($get_confirm_mail) {
        $_url = build_url(array('page' => 'newsletter', 'type' => 'confirm', 'email' => $email, 'confirm' => $code_confirm), get_module_zone('newsletter'));
        $url = $_url->evaluate();
        $newsletter_url = build_url(array('page' => 'newsletter'), get_module_zone('newsletter'));
        $message = do_lang('NEWSLETTER_SIGNUP_TEXT', comcode_escape($url), comcode_escape($password), array($forename, $surname, $email, get_site_name(), $newsletter_url->evaluate()), $language);
        require_code('mail');
        dispatch_mail(do_lang('NEWSLETTER_SIGNUP', null, null, null, $language), $message, array($email), null, '', '', array('bypass_queue' => true));
    }

    // Set subscription
    $GLOBALS['SITE_DB']->query_delete('newsletter_subscribe', array('newsletter_id' => $newsletter_id, 'email' => $email), '', 1);
    $GLOBALS['SITE_DB']->query_insert('newsletter_subscribe', array('newsletter_id' => $newsletter_id, 'email' => $email), false, true); // race condition

    return $password;
}

/**
 * Get text representing content categories the user can rearrange etc.
 *
 * @param  TIME $cutoff_time Cutoff time for when new content must be available
 * @param  LANGUAGE_NAME $lang Language to send in
 * @return string Categories
 */
function newsletter_get_category_choices($cutoff_time, $lang)
{
    require_code('global4');

    $chosen_categories = '';

    $_hooks = find_all_hook_obs('modules', 'admin_newsletter', 'Hook_whatsnew_');
    foreach ($_hooks as $hook => $object) {
        $done = false;
        if (method_exists($object, 'choose_categories')) {
            list($cats, $_title) = $object->choose_categories($cutoff_time);
            if (is_object($cats)) {
                $cats = $cats->evaluate($lang);
            }
            $matches = array();
            $num_matches = preg_match_all('#<option [^>]*value="([^"]*)"[^>]*>([^<]*)</option>#', $cats, $matches); // FUDGE: but it works
            if ($num_matches < 1500) { /*reasonable limit on how many categories to consider*/
                for ($i = 0; $i < $num_matches; $i++) {
                    $hook_result = $object->run($cutoff_time, $lang, $matches[1][$i]);
                    if ($hook_result == array()) {
                        continue;
                    }
                    list($hook_content, $_title) = $hook_result;
                    if (!$hook_content->is_empty()) {
                        $decoded = @html_entity_decode($matches[2][$i], ENT_QUOTES);
                        $chosen_categories .= $_title . ': ' . trim($decoded) . ' [' . $hook . '/' . $matches[1][$i] . "]\n";
                    }
                }
                $done = true;
            }
        }
        if (!$done) {
            $new = $object->run($cutoff_time, $lang, '*');
            if ($new != array()) {
                list($hook_content, $_title) = $new;
                if (!$hook_content->is_empty()) {
                    $chosen_categories .= $_title . ' [' . $hook . "]\n";
                }
            }
        }
    }

    return $chosen_categories;
}

/**
 * Generate Comcode for a what's new newsletter.
 *
 * @param  LONG_TEXT $chosen_categories Category selection
 * @param  BINARY $in_full Whether to show articles in full (as opposed to summaries)
 * @param  LANGUAGE_NAME $lang Language to send in
 * @param  TIME $cutoff_time When to cut off content from
 * @return ?string The Comcode (null: no content)
 */
function generate_whatsnew_comcode($chosen_categories, $in_full, $lang, $cutoff_time)
{
    require_code('global4');

    // Generate Comcode for content selected, drawing on hooks
    $automatic = array();
    $i = 0;
    $catarr = explode("\n", $chosen_categories);
    $_hooks = find_all_hook_obs('modules', 'admin_newsletter', 'Hook_whatsnew_');
    foreach ($_hooks as $hook => $object) {
        $found_one_match = false;
        $last_find_id = null;
        $last_cat_id = null;
        $filter = '';
        foreach ($catarr as $find_id => $line) {
            $matches = array();
            if (preg_match('#\[' . preg_quote($hook, '#') . '/(.*)\]#', $line, $matches) != 0) {
                $found_one_match = true;

                if (($last_find_id !== null) && (($find_id != $last_find_id + 1)/* || ($last_cat_id>intval($matches[1]))*/)) {
                    $last_cat_id = intval($matches[1]);

                    $temp = $object->run(intval($cutoff_time), $lang, $filter);
                    if (($temp === null) || (count($temp) == 0)) {
                        continue;
                    }
                    if (!$temp[0]->is_empty()) {
                        $tmp = do_template('NEWSLETTER_WHATSNEW_SECTION_FCOMCODE', array(
                            '_GUID' => 'bd228cdeafacfffac2d8d98d5f2da565',
                            'I' => strval($i + 1),
                            'TITLE' => $temp[1],
                            'CONTENT' => $temp[0],
                            'THUMBNAIL' => array_key_exists(2, $temp) ? $temp[2] : '',
                        ), null, false, null, '.txt', 'text');
                        $automatic[$last_find_id] = $tmp->evaluate($lang); /*FUDGE*/
                        $i++;
                    }

                    $filter = $matches[1];
                } else {
                    if ($filter != '') {
                        $filter .= ',';
                    }
                    $filter .= $matches[1];
                }

                $last_find_id = $find_id;
            }
        }
        if (!$found_one_match) {
            $found = false;
            foreach ($catarr as $find_id => $line) {
                if (strpos($line, '[' . $hook . ']') !== false) {
                    $found = true;
                    break;
                }
            }
            if (!$found) {
                continue;
            }

            $temp = $object->run(intval($cutoff_time), $lang, '*', $in_full);
            if (($temp === null) || (count($temp) == 0)) {
                continue;
            }
            if (!$temp[0]->is_empty()) {
                $tmp = do_template('NEWSLETTER_WHATSNEW_SECTION_FCOMCODE', array(
                    '_GUID' => '64c8870e7c75354c07b2e94f299cd38c',
                    'I' => strval($i + 1),
                    'TITLE' => $temp[1],
                    'CONTENT' => $temp[0],
                ), null, false, null, '.txt', 'text');
                $automatic[$find_id] = $tmp->evaluate($lang); /*FUDGE*/
                $i++;
            }
        } elseif ($filter != '') {
            $temp = $object->run(intval($cutoff_time), $lang, $filter, $in_full);
            if (($temp === null) || (count($temp) == 0)) {
                continue;
            }
            if (!$temp[0]->is_empty()) {
                $tmp = do_template('NEWSLETTER_WHATSNEW_SECTION_FCOMCODE', array(
                    '_GUID' => '8d1e7f448d11853b675a0949b8a0c2c9',
                    'I' => strval($i + 1),
                    'TITLE' => $temp[1],
                    'CONTENT' => $temp[0],
                ), null, false, null, '.txt', 'text');
                $automatic[$last_find_id] = $tmp->evaluate($lang); /*FUDGE*/
                $i++;
            }
        }
    }

    if (count($automatic) == 0) {
        return null;
    }

    ksort($automatic);
    $_automatic = '';
    foreach ($automatic as $tp) {
        $_automatic .= $tp;
    }
    $__message = do_template('NEWSLETTER_WHATSNEW_FCOMCODE', array('_GUID' => '20f6adc244b04d9e5206682ec4e0cc0f', 'CONTENT' => $_automatic), null, false, null, '.txt', 'text');
    $_message = $__message->evaluate($lang);

    $message = newsletter_wrap($_message, $lang);
    $message = newsletter_rewrap_with_early_comcode_parse_if_needed($_message, $message, $lang);

    return $message;
}

/**
 * Convert what may be a snippet of a newsletter, into a full newsletter with wrapper.
 * Find if it is HTML or Comcode.
 * Supports reading one referenced from the GET environment via 'from_news' parameter.
 * Supports reading one populated into the POST environment via 'message' parameter.
 *
 * @param  LONG_TEXT $_message A default newsletter message, with the newsletter wrapper assumed already-applied unless it's blank
 * @param  LANGUAGE_NAME $lang The language
 * @param  string $default_subject The default subject for this newsletter
 * @return array A pair: The newsletter message, Whether it is written in HTML
 */
function get_full_newsletter_code($_message, $lang, $default_subject)
{
    $_message = post_param_string('message', $_message);

    if ($_message == '') {
        // from_news GET parameter?
        $from_news = get_param_integer('from_news', null);
        if (($from_news !== null) && (addon_installed('news'))) {
            $rows = $GLOBALS['SITE_DB']->query_select('news', array('*'), array('id' => $from_news), '', 1);
            if (!array_key_exists(0, $rows)) {
                require_lang('news');
                warn_exit(do_lang_tempcode('MISSING_RESOURCE'));
            }
            $myrow = $rows[0];

            $_message = get_translated_text($myrow['news_article'], null, $lang);
            if ($_message == '') {
                $_message = get_translated_text($myrow['news'], null, $lang);
            }
        }

        $message = newsletter_wrap($_message, $lang, $default_subject);
        $message = newsletter_rewrap_with_early_comcode_parse_if_needed($_message, $message, $lang, $default_subject);
    } else {
        $message = $_message;
    }

    $final_message_is_html = (strpos(trim($message), '<') === 0);

    return array($message, $final_message_is_html);
}

/**
 * Apply the newsletter wrapper with a Comcode early parse, if we find the newsletter wrapper is sending us straight to HTML.
 *
 * @param  LONG_TEXT $_message The newsletter message without wrapper
 * @param  LONG_TEXT $message The newsletter message with wrapper
 * @param  LANGUAGE_NAME $lang The language
 * @param  SHORT_TEXT $subject The newsletter subject
 * @return string The newsletter with wrapper, with Comcode pre-parsed
 */
function newsletter_rewrap_with_early_comcode_parse_if_needed($_message, $message, $lang, $subject = '')
{
    $original_message_is_html = (strpos(trim($_message), '<') === 0);
    $final_message_is_html = (strpos(trim($message), '<') === 0);

    if ($final_message_is_html && !$original_message_is_html) {
        // Ah, can't allow Comcode through, as Comcode parser won't run after final send
        $html = static_evaluate_tempcode(comcode_to_tempcode($_message, get_member(), true));
        $tempcode_escaped_html = str_replace('{', '\{', $html);
        $message = newsletter_wrap($tempcode_escaped_html, $lang, $subject);
    }

    return $message;
}

/**
 * Apply the newsletter wrapper.
 *
 * @param  LONG_TEXT $_message The newsletter message
 * @param  LANGUAGE_NAME $lang The language
 * @param  SHORT_TEXT $subject The newsletter subject
 * @return string The newsletter with wrapper
 */
function newsletter_wrap($_message, $lang, $subject = '')
{
    $message_wrapped = do_template('NEWSLETTER_DEFAULT_FCOMCODE', array('_GUID' => '53c02947915806e519fe14c318813f42', 'CONTENT' => $_message, 'LANG' => $lang, 'SUBJECT' => $subject), null, false, null, '.txt', 'text');
    $message = $message_wrapped->evaluate($lang);
    return $message;
}

/**
 * Send out the newsletter.
 *
 * @param  LONG_TEXT $message The newsletter message
 * @param  SHORT_TEXT $subject The newsletter subject
 * @param  LANGUAGE_NAME $language The language
 * @param  array $send_details A map describing what newsletters the newsletter is being sent to
 * @param  BINARY $html_only Whether to only send in HTML format
 * @param  EMAIL $from_email Override the e-mail address the mail is sent from (blank: staff address)
 * @param  string $from_name Override the name the mail is sent from (blank: site name)
 * @param  integer $priority The message priority (1=urgent, 3=normal, 5=low)
 * @range  1 5
 * @param  string $csv_data CSV data of extra subscribers in JSON format (blank: none). This is in the same Composr newsletter CSV format that we export elsewhere.
 * @param  ID_TEXT $mail_template The template used to show the e-mail
 * @return Tempcode UI
 */
function send_newsletter($message, $subject, $language, $send_details, $html_only = 0, $from_email = '', $from_name = '', $priority = 3, $csv_data = '', $mail_template = 'MAIL')
{
    require_lang('newsletter');

    // Put in archive
    $archive_map = array(
        'subject' => $subject,
        'newsletter' => $message,
        'language' => $language,
        'from_email' => $from_email,
        'from_name' => $from_name,
        'priority' => $priority,
        'template' => $mail_template,
        'html_only' => $html_only,
    );
    $message_id = $GLOBALS['SITE_DB']->query_select_value_if_there('newsletter_archive', 'id', $archive_map);
    if ($message_id === null) {
        $message_id = $GLOBALS['SITE_DB']->query_insert('newsletter_archive', $archive_map + array('date_and_time' => time()), true);
    }

    // Mark as done
    log_it('NEWSLETTER_SEND', $subject);
    set_value('newsletter_send_time', strval(time()));

    // Schedule the task
    require_code('tasks');
    return call_user_func_array__long_task(do_lang('NEWSLETTER_SEND'), get_screen_title('NEWSLETTER_SEND'), 'send_newsletter', array($message_id, $message, $subject, $language, $send_details, $html_only, $from_email, $from_name, $priority, $csv_data, $mail_template), false, get_param_integer('keep_send_immediately', 0) == 1, false);
}

/**
 * Find a group of people the newsletter will go to.
 *
 * @param  array $send_details A map describing what newsletters the newsletter is being sent to
 * @param  LANGUAGE_NAME $language The language
 * @param  integer $start Start position in result set (results are returned in parallel for each category of result)
 * @param  integer $max Maximum records to return from each category
 * @param  boolean $get_raw_rows Whether to get raw rows rather than mailer-ready correspondence lists
 * @param  string $csv_data JSON CSV data to also consider
 * @return array Returns a tuple of corresponding detail lists, emails,hashes,usernames,forenames,surnames,ids, and a record count for newsletters (depending on requests: csv, 1, <newsletterID>, g<groupID>) [record counts not returned if $start is not zero, for performance reasons]
 */
function newsletter_who_send_to($send_details, $language, $start, $max, $get_raw_rows = false, $csv_data = '')
{
    // Find who to send to
    $usernames = array();
    $forenames = array();
    $surnames = array();
    $emails = array();
    $ids = array();
    $hashes = array();
    $total = array();
    $raw_rows = array();

    // Standard newsletter subscribers
    $newsletters = $GLOBALS['SITE_DB']->query_select('newsletters', array('*'));
    foreach ($newsletters as $newsletter) {
        if (!empty($send_details[strval($newsletter['id'])])) {
            $where_lang = multi_lang() ? (db_string_equal_to('language', $language) . ' AND ') : '';
            $query = ' FROM ' . get_table_prefix() . 'newsletter_subscribe s LEFT JOIN ' . get_table_prefix() . 'newsletter_subscribers n ON n.email=s.email WHERE ' . $where_lang . 'code_confirm=0 AND s.newsletter_id=' . strval($newsletter['id']);

            $sql = 'SELECT n.id,n.email,the_password,n_forename,n_surname' . $query . ' ORDER BY n.id';
            $temp = $GLOBALS['SITE_DB']->query($sql, $max, $start);

            if ($start == 0) {
                $sql = 'SELECT COUNT(*)' . $query;
                $total[strval($newsletter['id'])] = $GLOBALS['SITE_DB']->query_value_if_there($sql);
            }

            foreach ($temp as $_temp) {
                if (!in_array($_temp['email'], $emails)) { // If not already added
                    if (!$get_raw_rows) {
                        $emails[] = $_temp['email'];
                        $forenames[] = $_temp['n_forename'];
                        $surnames[] = $_temp['n_surname'];
                        $username = trim($_temp['n_forename'] . ' ' . $_temp['n_surname']);
                        if ($username == '') {
                            $username = do_lang('NEWSLETTER_SUBSCRIBER_DEFAULT_NAME', get_site_name());
                        }
                        $usernames[] = $username;
                        $ids[] = 'n' . strval($_temp['id']);
                        require_code('crypt');
                        $hashes[] = ratchet_hash($_temp['the_password'], 'xunsub');
                    } else {
                        $raw_rows[] = $_temp;
                    }
                }
            }
        }
    }

    // Conversr imports
    if (get_forum_type() == 'cns') {
        $where_lang = multi_lang() ? ('(' . db_string_equal_to('m_language', $language) . ' OR ' . db_string_equal_to('m_language', '') . ') AND ') : '';

        // Usergroups
        foreach ($send_details as $_id => $is_on) {
            if ((is_string($_id)) && (substr($_id, 0, 1) == 'g') && (!empty($is_on))) {
                $id = intval(substr($_id, 1));
                $fields = 'm.id,m.m_email_address,m.m_username,m.m_pass_hash_salted';
                $query = 'SELECT xxxxx  FROM ' . $GLOBALS['FORUM_DB']->get_table_prefix() . 'f_members m LEFT JOIN ' . $GLOBALS['FORUM_DB']->get_table_prefix() . 'f_group_members g ON m.id=g.gm_member_id AND g.gm_validated=1 WHERE ' . db_string_not_equal_to('m_email_address', '') . ' AND ' . $where_lang . 'm_validated=1 AND gm_group_id=' . strval($id);
                if (get_option('staff_email_receipt_configurability') != '0') {
                    $query .= ' AND m_allow_emails=1';
                }
                $query .= ' AND m_is_perm_banned=0';
                $query .= ' UNION SELECT xxxxx FROM ' . $GLOBALS['FORUM_DB']->get_table_prefix() . 'f_members m WHERE ' . db_string_not_equal_to('m_email_address', '') . ' AND ' . $where_lang . 'm_validated=1 AND m_primary_group=' . strval($id);
                if (get_option('staff_email_receipt_configurability') != '0') {
                    $query .= ' AND m_allow_emails=1';
                }
                $query .= ' AND m_is_perm_banned=0';
                $_rows = $GLOBALS['FORUM_DB']->query(str_replace('xxxxx', $fields, $query) . ' ORDER BY id', $max, $start, false, true);
                if ($start == 0) {
                    $total['g' . strval($id)] = $GLOBALS['FORUM_DB']->query_value_if_there('SELECT (' . str_replace(' UNION ', ') + (', str_replace('xxxxx', 'COUNT(*)', $query)) . ')', false, true);
                }

                foreach ($_rows as $_temp) { // For each member
                    if (!in_array($_temp['m_email_address'], $emails)) { // If not already added
                        if (!$get_raw_rows) {
                            $emails[] = $_temp['m_email_address'];
                            $forenames[] = '';
                            $surnames[] = '';
                            $usernames[] = $_temp['m_username'];
                            $ids[] = 'm' . strval($_temp['id']);
                            $hashes[] = ratchet_hash($_temp['m_pass_hash_salted'], 'xunsub');
                        } else {
                            $raw_rows[] = $_temp;
                        }
                    }
                }
            }
        }

        // *All* Conversr members
        if (!empty($send_details['-1'])) {
            $query = ' FROM ' . $GLOBALS['FORUM_DB']->get_table_prefix() . 'f_members WHERE ' . db_string_not_equal_to('m_email_address', '') . ' AND ' . $where_lang . 'm_validated=1';
            if (get_option('staff_email_receipt_configurability') != '0') {
                $query .= ' AND m_allow_emails=1';
            }
            $query .= ' AND m_is_perm_banned=0';
            $_rows = $GLOBALS['FORUM_DB']->query('SELECT id,m_email_address,m_username,m_pass_hash_salted' . $query, $max, $start);
            if ($start == 0) {
                $total['-1'] = $GLOBALS['FORUM_DB']->query_value_if_there('SELECT COUNT(*)' . $query);
            }
            foreach ($_rows as $_temp) {
                if (!in_array($_temp['m_email_address'], $emails)) { // If not already added
                    if (!$get_raw_rows) {
                        $emails[] = $_temp['m_email_address'];
                        $forenames[] = '';
                        $surnames[] = '';
                        $usernames[] = $_temp['m_username'];
                        $ids[] = 'm' . strval($_temp['id']);
                        $hashes[] = ratchet_hash($_temp['m_pass_hash_salted'], 'xunsub');
                    } else {
                        $raw_rows[] = $_temp;
                    }
                }
            }
        }
    }

    // From CSV
    if ($csv_data != '') {
        $_csv_data = json_decode($csv_data, true);

        $email_index = 0;
        $forename_index = 1;
        $surname_index = 2;
        $username_index = 3;
        $id_index = 4;
        $hash_index = 5;

        if ($start == 0) {
            $total['csv'] = 0;
        }

        $pos = 0;
        foreach ($_csv_data as $i => $csv_line) {
            if (($i <= 0) && (count($csv_line) >= 1) && (isset($csv_line[0])) && (strpos($csv_line[0], '@') === false) && (isset($csv_line[1])) && (strpos($csv_line[1], '@') === false)) {
                foreach ($csv_line as $j => $val) {
                    if (in_array(strtolower($val), array('e-mail', 'email', 'email address', 'e-mail address'))) {
                        $email_index = $j;
                    }
                    if (in_array(strtolower($val), array('forename', 'forenames', 'first name'))) {
                        $forename_index = $j;
                    }
                    if (in_array(strtolower($val), array('surname', 'surnames', 'last name'))) {
                        $surname_index = $j;
                    }
                    if (in_array(strtolower($val), array('username'))) {
                        $username_index = $j;
                    }
                    if (in_array(strtolower($val), array('id', 'identifier'))) {
                        $id_index = $j;
                    }
                    if (in_array(strtolower($val), array('hash', 'password', 'pass', 'code', 'secret'))) {
                        $hash_index = $j;
                    }
                }
                continue;
            }

            if ((count($csv_line) >= 1) && ($csv_line[$email_index] !== null) && (strpos($csv_line[$email_index], '@') !== false)) {
                if (($pos >= $start) && ($pos - $start < $max)) {
                    if (!$get_raw_rows) {
                        $emails[] = $csv_line[$email_index];
                        $forenames[] = array_key_exists($forename_index, $csv_line) ? $csv_line[$forename_index] : '';
                        $surnames[] = array_key_exists($surname_index, $csv_line) ? $csv_line[$surname_index] : '';
                        $usernames[] = array_key_exists($username_index, $csv_line) ? $csv_line[$username_index] : '';
                        $ids[] = array_key_exists($id_index, $csv_line) ? $csv_line[$id_index] : '';
                        $hashes[] = array_key_exists($hash_index, $csv_line) ? $csv_line[$hash_index] : '';
                    } else {
                        $raw_rows[] = $csv_line;
                    }
                }
                if ($start == 0) {
                    $total['csv']++;
                }

                $pos++;
            }
        }
    }
    return array($emails, $hashes, $usernames, $forenames, $surnames, $ids, $total, $raw_rows);
}

/**
 * Sub in newsletter variables.
 *
 * @param  string $message The original newsletter message
 * @param  SHORT_TEXT $subject The newsletter subject
 * @param  SHORT_TEXT $forename Subscribers forename (blank: unknown)
 * @param  SHORT_TEXT $surname Subscribers surname (blank: unknown)
 * @param  SHORT_TEXT $name Subscribers name (or username)
 * @param  EMAIL $email_address Subscribers e-mail address
 * @param  ID_TEXT $sendid Specially encoded ID of subscriber (begins either 'n' for newsletter subscriber, or 'm' for member - then has normal subscriber/member ID following)
 * @param  SHORT_TEXT $hash Double encoded password hash of subscriber (blank: can not unsubscribe by URL)
 * @return string The new newsletter message
 */
function newsletter_variable_substitution($message, $subject, $forename, $surname, $name, $email_address, $sendid, $hash)
{
    $unsub_url = new Tempcode();
    if ($hash == '') {
        $unsub_url = build_url(array('page' => 'members', 'type' => 'view'), get_module_zone('members'), array(), false, false, true, 'tab--edit');
    } else {
        if (substr($sendid, 0, 1) == 'm') {
            $unsub_url = build_url(array('page' => 'members', 'type' => 'unsub', 'id' => substr($sendid, 1), 'hash' => $hash), get_module_zone('members'), array(), false, false, true);
        } else {
            $unsub_url = build_url(array('page' => 'newsletter', 'type' => 'unsub', 'id' => substr($sendid, 1), 'hash' => $hash), get_module_zone('newsletter'), array(), false, false, true);
        }
    }

    $member_id = null;
    if (substr($sendid, 0, 1) == 'm') {
        $member_id = $GLOBALS['FORUM_DRIVER']->get_member_from_username($name);
        $name = $GLOBALS['FORUM_DRIVER']->get_displayname($name);
    }

    require_lang('newsletter');

    $vars = array(
        'title' => $subject,
        'forename' => $forename,
        'surname' => $surname,
        'name' => $name,
        'member_id' => empty($member_id) ? '' : strval($member_id),
        'email_address' => $email_address,
        'sendid' => $sendid,
        'unsub_url' => $unsub_url,
        'unsub_comcode' => do_lang(empty($member_id) ? 'NEWSLETTER_UNSUBSCRIBE_NEWSLETTER' : 'NEWSLETTER_UNSUBSCRIBE_MEMBER', $unsub_url->evaluate()),
    );

    foreach ($vars as $var => $sub) {
        $message = str_replace('{' . $var . '}', is_object($sub) ? $sub->evaluate() : $sub, $message);
        $message = str_replace('{' . $var . '*}', escape_html(is_object($sub) ? $sub->evaluate() : $sub), $message);
    }

    return $message;
}

/**
 * Generate a newsletter preview in full HTML and full text.
 *
 * @param  string $message The message
 * @param  string $subject The subject
 * @param  boolean $html_only Send in HTML only
 * @param  ?string $forename Forename (null: reasonable default)
 * @param  ?string $surname Surname (null: reasonable default)
 * @param  ?string $name Name (null: reasonable default)
 * @param  ?string $address Address (null: reasonable default)
 * @param  ?string $sendid Send ID (null: reasonable default)
 * @param  ?string $hash Password hash (null: reasonable default)
 * @param  ID_TEXT $template The mail template to preview with
 * @return array A triple: HTML version, Text version, Whether the e-mail has to be fully HTML
 */
function newsletter_preview($message, $subject, $html_only, $forename = null, $surname = null, $name = null, $address = null, $sendid = null, $hash = null, $template = 'MAIL')
{
    if ($forename === null) {
        $forename = do_lang('SAMPLE_FORENAME');
    }

    if ($surname === null) {
        $surname = do_lang('SAMPLE_SURNAME');
    }

    if ($name === null) {
        $name = do_lang('SAMPLE_NAME');
    }

    if ($address === null) {
        $address = $GLOBALS['FORUM_DRIVER']->get_member_email_address(get_member());
        if ($address == '') {
            $address = do_lang('SAMPLE_ADDRESS');
        }
    }

    if ($sendid === null) {
        $sendid = 'm' . strval(get_member());
    }

    if ($hash === null) {
        require_code('crypt');
        $hash = ratchet_hash($GLOBALS['FORUM_DRIVER']->get_member_row_field(get_member(), 'm_pass_hash_salted'), 'xunsub');
    }

    require_code('tempcode_compiler');

    // HTML message
    $message = newsletter_variable_substitution($message, $subject, $forename, $surname, $name, $address, $sendid, $hash);
    if (stripos(trim($message), '<') === 0) {
        // Is already full HTML (with maybe some Tempcode)

        $html_version = template_to_tempcode($message);

        $html_only = true; // Force on, regardless
    } else {
        // Is Comcode

        require_code('media_renderer');
        push_media_mode(peek_media_mode() | MEDIA_LOWFI);
        $comcode_version = comcode_to_tempcode($message, get_member(), true);
        pop_media_mode();

        $html_version = do_template(
            $template,
            array(
                '_GUID' => 'b081cf9104748b090f63b6898027985e',
                'TITLE' => $subject,
                'CSS' => css_tempcode(true, true, $comcode_version->evaluate()),
                'LANG' => get_site_default_lang(),
                'LOGOURL' => get_logo_url(''),
                'CONTENT' => $comcode_version,
            ),
            null,
            false,
            null,
            '.tpl',
            'templates',
            $GLOBALS['FORUM_DRIVER']->get_theme('')
        );
    }

    // Text message
    $text_version = $html_only ? '' : strip_comcode($message);

    return array($html_version, $text_version, $html_only);
}

/**
 * Work out newsletter block list.
 *
 * @return array List of blocked e-mail addresses (actually a map)
 */
function newsletter_block_list()
{
    $blocked = array();
    $block_path = get_custom_file_base() . '/uploads/website_specific/newsletter_blocked.csv';
    if (is_file($block_path)) {
        cms_ini_set('auto_detect_line_endings', '1'); // TODO: Remove with #3032
        $myfile = fopen($block_path, 'rb');
        // TODO: #3032
        while (($row = fgetcsv($myfile, 1024)) !== false) {
            if ($row[0] != '') {
                $blocked[$row[0]] = true;
            }
        }
        fclose($myfile);
    }
    return $blocked;
}

/**
 * Make a newsletter.
 *
 * @param  SHORT_TEXT $title The title
 * @param  LONG_TEXT $description The description
 * @return AUTO_LINK The ID
 */
function add_newsletter($title, $description)
{
    require_code('global4');
    prevent_double_submit('ADD_NEWSLETTER', null, $title);

    $map = array();
    $map += insert_lang('title', $title, 2);
    $map += insert_lang('description', $description, 2);
    $id = $GLOBALS['SITE_DB']->query_insert('newsletters', $map, true);

    if ((addon_installed('commandr')) && (!running_script('install'))) {
        require_code('resource_fs');
        generate_resource_fs_moniker('newsletter', strval($id), null, null, true);
    }

    log_it('ADD_NEWSLETTER', strval($id), $title);

    delete_cache_entry('main_newsletter_signup');

    return $id;
}

/**
 * Edit a newsletter.
 *
 * @param  AUTO_LINK $id The ID
 * @param  SHORT_TEXT $title The title
 * @param  LONG_TEXT $description The description
 */
function edit_newsletter($id, $title, $description)
{
    $rows = $GLOBALS['SITE_DB']->query_select('newsletters', array('*'), array('id' => $id), '', 1);

    if (!array_key_exists(0, $rows)) {
        warn_exit(do_lang_tempcode('MISSING_RESOURCE', 'newsletter'));
    }

    $myrow = $rows[0];
    $_title = $myrow['title'];
    $_description = $myrow['description'];
    $map = array();
    $map += lang_remap('title', $_title, $title);
    $map += lang_remap('description', $_description, $description);
    $GLOBALS['SITE_DB']->query_update('newsletters', $map, array('id' => $id), '', 1);

    if ((addon_installed('commandr')) && (!running_script('install'))) {
        require_code('resource_fs');
        generate_resource_fs_moniker('newsletter', strval($id));
    }

    log_it('EDIT_NEWSLETTER', strval($id), $_title);

    delete_cache_entry('main_newsletter_signup');
}

/**
 * Delete a newsletter.
 *
 * @param  AUTO_LINK $id The ID
 */
function delete_newsletter($id)
{
    $rows = $GLOBALS['SITE_DB']->query_select('newsletters', array('*'), array('id' => $id), '', 1);

    if (!array_key_exists(0, $rows)) {
        warn_exit(do_lang_tempcode('INTERNAL_ERROR'));
    }

    $myrow = $rows[0];
    $_title = $myrow['title'];
    $_description = $myrow['description'];

    $GLOBALS['SITE_DB']->query_delete('newsletters', array('id' => $id), '', 1);
    $GLOBALS['SITE_DB']->query_delete('newsletter_subscribe', array('newsletter_id' => $id));
    delete_lang($_title);
    delete_lang($_description);

    if ((addon_installed('commandr')) && (!running_script('install'))) {
        require_code('resource_fs');
        expunge_resource_fs_moniker('newsletter', strval($id));
    }

    log_it('DELETE_NEWSLETTER', strval($id), get_translated_text($_title));

    delete_cache_entry('main_newsletter_signup');
}

/**
 * Make a periodic newsletter.
 *
 * @param  LONG_TEXT $subject Subject
 * @param  LONG_TEXT $message Message
 * @param  LANGUAGE_NAME $lang Language to send for
 * @param  LONG_TEXT $send_details The data sent in each newsletter
 * @param  BINARY $html_only Whether to send in HTML only
 * @param  SHORT_TEXT $from_email From address
 * @param  SHORT_TEXT $from_name From name
 * @param  SHORT_INTEGER $priority Priority
 * @param  LONG_TEXT $csv_data CSV data of who to send to (JSON)
 * @param  SHORT_TEXT $frequency Send frequency
 * @set weekly biweekly monthly
 * @param  SHORT_INTEGER $day Weekday to send on
 * @param  BINARY $in_full Embed full articles
 * @param  ID_TEXT $template Mail template to use, e.g. MAIL
 * @param  ?TIME $last_sent When was last sent (null: now)
 * @return AUTO_LINK The ID
 */
function add_periodic_newsletter($subject, $message, $lang, $send_details, $html_only, $from_email, $from_name, $priority, $csv_data, $frequency, $day, $in_full = 0, $template = 'MAIL', $last_sent = null)
{
    require_code('global4');
    prevent_double_submit('ADD_PERIODIC_NEWSLETTER', null, $subject);

    if ($last_sent === null) {
        $last_sent = time();
    }

    $id = $GLOBALS['SITE_DB']->query_insert('newsletter_periodic', array(
        'np_subject' => $subject,
        'np_message' => $message,
        'np_lang' => $lang,
        'np_send_details' => $send_details,
        'np_html_only' => $html_only,
        'np_from_email' => $from_email,
        'np_from_name' => $from_name,
        'np_priority' => $priority,
        'np_csv_data' => $csv_data,
        'np_frequency' => $frequency,
        'np_day' => $day,
        'np_in_full' => $in_full,
        'np_template' => $template,
        'np_last_sent' => $last_sent,
    ), true);

    if ((addon_installed('commandr')) && (!running_script('install'))) {
        require_code('resource_fs');
        generate_resource_fs_moniker('periodic_newsletter', strval($id), null, null, true);
    }

    log_it('ADD_PERIODIC_NEWSLETTER', strval($id), $subject);

    return $id;
}

/**
 * Edit a periodic newsletter.
 *
 * @param  AUTO_LINK $id The ID
 * @param  LONG_TEXT $subject Subject
 * @param  LONG_TEXT $message Message
 * @param  LANGUAGE_NAME $lang Language to send for
 * @param  LONG_TEXT $send_details The data sent in each newsletter
 * @param  BINARY $html_only Whether to send in HTML only
 * @param  SHORT_TEXT $from_email From address
 * @param  SHORT_TEXT $from_name From name
 * @param  SHORT_INTEGER $priority Priority
 * @param  LONG_TEXT $csv_data CSV data of who to send to (JSON)
 * @param  SHORT_TEXT $frequency Send frequency
 * @set weekly biweekly monthly
 * @param  SHORT_INTEGER $day Weekday to send on
 * @param  BINARY $in_full Embed full articles
 * @param  ID_TEXT $template Mail template to use, e.g. MAIL
 * @param  ?TIME $last_sent When was last sent (null: don't change)
 */
function edit_periodic_newsletter($id, $subject, $message, $lang, $send_details, $html_only, $from_email, $from_name, $priority, $csv_data, $frequency, $day, $in_full, $template, $last_sent = null)
{
    $rows = $GLOBALS['SITE_DB']->query_select('newsletter_periodic', array('*'), array('id' => $id), '', 1);

    if (!array_key_exists(0, $rows)) {
        warn_exit(do_lang_tempcode('MISSING_RESOURCE'));
    }

    $map = array(
        'np_subject' => $subject,
        'np_message' => $message,
        'np_lang' => $lang,
        'np_send_details' => $send_details,
        'np_html_only' => $html_only,
        'np_from_email' => $from_email,
        'np_from_name' => $from_name,
        'np_priority' => $priority,
        'np_csv_data' => $csv_data,
        'np_frequency' => $frequency,
        'np_day' => $day,
        'np_in_full' => $in_full,
        'np_template' => $template,
    );
    if ($last_sent !== null) {
        $map['np_last_sent'] = $last_sent;
    }
    $GLOBALS['SITE_DB']->query_update('newsletter_periodic', $map, array('id' => $id));

    if ((addon_installed('commandr')) && (!running_script('install'))) {
        require_code('resource_fs');
        generate_resource_fs_moniker('periodic_newsletter', strval($id));
    }

    log_it('EDIT_PERIODIC_NEWSLETTER', strval($id), $subject);
}

/**
 * Delete a periodic newsletter.
 *
 * @param  AUTO_LINK $id The ID
 */
function delete_periodic_newsletter($id)
{
    $rows = $GLOBALS['SITE_DB']->query_select('newsletter_periodic', array('*'), array('id' => $id), '', 1);

    if (!array_key_exists(0, $rows)) {
        warn_exit(do_lang_tempcode('INTERNAL_ERROR'));
    }

    $subject = $rows[0]['np_subject'];

    $GLOBALS['SITE_DB']->query_delete('newsletter_periodic', array('id' => $id));

    if ((addon_installed('commandr')) && (!running_script('install'))) {
        require_code('resource_fs');
        expunge_resource_fs_moniker('periodic_newsletter', strval($id));
    }

    log_it('DELETE_PERIODIC_NEWSLETTER', strval($id), $subject);
}

/**
 * Add a newsletter subscriber to the system (not to any particular newsletters though).
 *
 * @param  EMAIL $email The e-mail address of the subscriber
 * @param  TIME $join_time The join time
 * @param  integer $code_confirm Confirm code
 * @param  ID_TEXT $password Newsletter password (hashed)
 * @param  ID_TEXT $salt Newsletter salt
 * @param  LANGUAGE_NAME $language The language
 * @param  string $forename Subscribers forename
 * @param  string $surname Subscribers surname
 * @return AUTO_LINK Subscriber ID
 */
function add_newsletter_subscriber($email, $join_time, $code_confirm, $password, $salt, $language, $forename, $surname)
{
    $GLOBALS['SITE_DB']->query_delete('newsletter_subscribers', array(
        'email' => $email,
    ));
    $id = $GLOBALS['SITE_DB']->query_insert('newsletter_subscribers', array(
        'email' => $email,
        'join_time' => $join_time,
        'code_confirm' => $code_confirm,
        'the_password' => $password,
        'pass_salt' => $salt,
        'language' => $language,
        'n_forename' => $forename,
        'n_surname' => $surname,
    ), true, true/*race condition*/);

    if ((addon_installed('commandr')) && (!running_script('install')) && (!get_mass_import_mode())) {
        require_code('resource_fs');
        generate_resource_fs_moniker('newsletter_subscriber', strval($id), null, null, true);
    }

    return $id;
}

/**
 * Edit a newsletter subscriber.
 *
 * @param  AUTO_LINK $id Subscriber ID
 * @param  ?EMAIL $email The e-mail address of the subscriber (null: don't change)
 * @param  ?TIME $join_time The join time (null: don't change)
 * @param  ?integer $code_confirm Confirm code (null: don't change)
 * @param  ?ID_TEXT $password Newsletter password (hashed) (null: don't change)
 * @param  ?ID_TEXT $salt Newsletter salt (null: don't change)
 * @param  ?LANGUAGE_NAME $language The language (null: don't change)
 * @param  ?string $forename Subscribers forename (null: don't change)
 * @param  ?string $surname Subscribers surname (null: don't change)
 */
function edit_newsletter_subscriber($id, $email = null, $join_time = null, $code_confirm = null, $password = null, $salt = null, $language = null, $forename = null, $surname = null)
{
    $map = array();
    if ($email !== null) {
        $map['email'] = $email;
    }
    if ($join_time !== null) {
        $map['join_time'] = $join_time;
    }
    if ($code_confirm !== null) {
        $map['code_confirm'] = $code_confirm;
    }
    if ($password !== null) {
        $map['the_password'] = $password;
    }
    if ($salt !== null) {
        $map['pass_salt'] = $salt;
    }
    if ($language !== null) {
        $map['language'] = $language;
    }
    if ($forename !== null) {
        $map['n_forename'] = $forename;
    }
    if ($surname !== null) {
        $map['n_surname'] = $surname;
    }

    $GLOBALS['SITE_DB']->query_update('newsletter_subscribers', $map, array('id' => $id), '', 1);

    if ((addon_installed('commandr')) && (!running_script('install'))) {
        require_code('resource_fs');
        generate_resource_fs_moniker('newsletter_subscriber', strval($id));
    }
}

/**
 * Delete a newsletter subscriber.
 *
 * @param  AUTO_LINK $id Subscriber ID
 */
function delete_newsletter_subscriber($id)
{
    $GLOBALS['SITE_DB']->query_delete('newsletter_subscribers', array('id' => $id), '', 1);

    if ((addon_installed('commandr')) && (!running_script('install'))) {
        require_code('resource_fs');
        expunge_resource_fs_moniker('newsletter_subscriber', strval($id));
    }
}

/**
 * Remove bounced addresses from the newsletter / turn off staff e-mails on member accounts.
 *
 * @param  array $bounces List of e-mail addresses
 */
function remove_email_bounces($bounces)
{
    if (count($bounces) == 0) {
        return;
    }

    $delete_sql = '';
    $delete_sql_members = '';

    foreach ($bounces as $email_address) {
        if ($delete_sql != '') {
            $delete_sql .= ' OR ';
            $delete_sql_members .= ' OR ';
        }
        $delete_sql .= db_string_equal_to('email', $email_address);
        $delete_sql_members .= db_string_equal_to('m_email_address', $email_address);
    }

    $query = 'DELETE FROM ' . get_table_prefix() . 'newsletter_subscribers WHERE ' . $delete_sql;
    $GLOBALS['SITE_DB']->query($query);

    $query = 'DELETE FROM ' . get_table_prefix() . 'newsletter_subscribe WHERE ' . $delete_sql;
    $GLOBALS['SITE_DB']->query($query);

    if (get_forum_type() == 'cns') {
        $query = 'UPDATE ' . $GLOBALS['FORUM_DB']->get_table_prefix() . 'f_members SET m_allow_emails_from_staff=0 WHERE ' . $delete_sql_members;
        $GLOBALS['FORUM_DB']->query($query);
    }
}
